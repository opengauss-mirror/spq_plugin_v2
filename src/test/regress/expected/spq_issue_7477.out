--- Test for updating a table that has a foreign key reference to another reference table.
--- Issue #7477: Distributed deadlock after issuing a simple UPDATE statement
--- https://github.com/citusdata/citus/issues/7477
select success, result from run_command_on_all_nodes(
    $$CREATE TABLE table1 (id INT PRIMARY KEY);$$
);
 success |    result
---------------------------------------------------------------------
 t       | CREATE TABLE
 t       | CREATE TABLE
 t       | CREATE TABLE
(3 rows)

--SELECT create_reference_table('table1');
select success, result from run_command_on_all_nodes(
    $$INSERT INTO table1 VALUES (1);$$
);
 success |   result
---------------------------------------------------------------------
 t       | INSERT 0 1
 t       | INSERT 0 1
 t       | INSERT 0 1
(3 rows)

select success, result from run_command_on_all_nodes(
    $$CREATE TABLE table2 (
        id INT,
        info TEXT,
        CONSTRAINT table1_id_fk FOREIGN KEY (id) REFERENCES table1 (id)
    );$$
);
 success |    result
---------------------------------------------------------------------
 t       | CREATE TABLE
 t       | CREATE TABLE
 t       | CREATE TABLE
(3 rows)

--SELECT create_reference_table('table2');
select success, result from run_command_on_all_nodes(
    $$INSERT INTO table2 VALUES (1, 'test');$$
);
 success |   result
---------------------------------------------------------------------
 t       | INSERT 0 1
 t       | INSERT 0 1
 t       | INSERT 0 1
(3 rows)

--- Runs the update command in parallel on workers.
--- Due to bug #7477, before the fix, the result is non-deterministic
--- and have several rows of the form:
---  localhost |     57638 | f       | ERROR:  deadlock detected
---  localhost |     57637 | f       | ERROR:  deadlock detected
---  localhost |     57637 | f       | ERROR:  canceling the transaction since it was involved in a distributed deadlock
SELECT * FROM master_run_on_worker(
    ARRAY['localhost', 'localhost','localhost', 'localhost','localhost',
            'localhost','localhost', 'localhost','localhost', 'localhost']::text[],
    ARRAY[:worker_2_port, :worker_1_port, :worker_1_port, :worker_2_port, :worker_1_port, :worker_2_port, :worker_1_port, :worker_2_port, :worker_2_port, :worker_1_port]::int[],
    ARRAY['UPDATE table2 SET info = ''test_update'' WHERE id = 1',
            'UPDATE table2 SET info = ''test_update'' WHERE id = 1',
            'UPDATE table2 SET info = ''test_update'' WHERE id = 1',
            'UPDATE table2 SET info = ''test_update'' WHERE id = 1',
            'UPDATE table2 SET info = ''test_update'' WHERE id = 1',
            'UPDATE table2 SET info = ''test_update'' WHERE id = 1',
            'UPDATE table2 SET info = ''test_update'' WHERE id = 1',
            'UPDATE table2 SET info = ''test_update'' WHERE id = 1',
            'UPDATE table2 SET info = ''test_update'' WHERE id = 1',
            'UPDATE table2 SET info = ''test_update'' WHERE id = 1'
            ]::text[],
    true);
 node_name | node_port | success |  result
---------------------------------------------------------------------
 localhost | xxxxx | t       | UPDATE 1
 localhost | xxxxx | t       | UPDATE 1
 localhost | xxxxx | t       | UPDATE 1
 localhost | xxxxx | t       | UPDATE 1
 localhost | xxxxx | t       | UPDATE 1
 localhost | xxxxx | t       | UPDATE 1
 localhost | xxxxx | t       | UPDATE 1
 localhost | xxxxx | t       | UPDATE 1
 localhost | xxxxx | t       | UPDATE 1
 localhost | xxxxx | t       | UPDATE 1
(10 rows)

--- cleanup
select success, result from run_command_on_all_nodes(
    $cmd$DROP TABLE IF EXISTS table2;$cmd$
);
 success |   result
---------------------------------------------------------------------
 t       | DROP TABLE
 t       | DROP TABLE
 t       | DROP TABLE
(3 rows)

select success, result from run_command_on_all_nodes(
    $cmd$DROP TABLE IF EXISTS table1;$cmd$
);
 success |   result
---------------------------------------------------------------------
 t       | DROP TABLE
 t       | DROP TABLE
 t       | DROP TABLE
(3 rows)

