----------------------- test 1: add new node && start rebalance -----------------------------
\c - - - :master_port
SET spq.next_shard_id TO 2000000;
SELECT spq_remove_node('localhost', :worker_2_port);
 spq_remove_node
---------------------------------------------------------------------

(1 row)

create table t1 (id int primary key, b varchar(10));
NOTICE:  CREATE TABLE / PRIMARY KEY will create implicit index "t1_pkey" for table "t1"
insert into t1 values (1, '[1, 2]');
insert into t1 values (2, '[1, 2]');
insert into t1 values (3, '[1, 2]');
insert into t1 values (4, '[1, 2]');
insert into t1 values (5, '[1, 2]');
insert into t1 values (6, '[1, 2]');
insert into t1 values (7, '[1, 2]');
insert into t1 values (8, '[1, 2]');
insert into t1 values (9, '[1, 2]');
insert into t1 values (10, '[1, 2]');
insert into t1 values (11, '[1, 2]');
insert into t1 values (12, '[1, 2]');
insert into t1 values (13, '[1, 2]');
insert into t1 values (14, '[1, 2]');
insert into t1 values (15, '[1, 2]');
insert into t1 values (16, '[1, 2]');
insert into t1 values (17, '[1, 2]');
insert into t1 values (18, '[1, 2]');
insert into t1 values (19, '[1, 2]');
insert into t1 values (20, '[1, 2]');
select create_distributed_table('t1', 'id', shard_count:=10);
NOTICE:  Copying data from local table...
CONTEXT:  referenced column: create_distributed_table
NOTICE:  copying the data has completed
DETAIL:  The local data in the table is no longer visible, but is still on disk.
HINT:  To remove the local data, run: SELECT truncate_local_data_after_distributing_table($$public.t1$$)
CONTEXT:  referenced column: create_distributed_table
 create_distributed_table
---------------------------------------------------------------------

(1 row)

select * from spq_shards;
 table_name | shardid | shard_name | table_type  | nodename  | nodeport | shard_size
---------------------------------------------------------------------
 t1         | 2000000 | txx_xxxx | distributed | localhost |    58639 |      24576
 t1         | 2000001 | txx_xxxx | distributed | localhost |    58639 |      24576
 t1         | 2000002 | txx_xxxx | distributed | localhost |    58639 |      24576
 t1         | 2000003 | txx_xxxx | distributed | localhost |    58639 |      24576
 t1         | 2000004 | txx_xxxx | distributed | localhost |    58639 |      24576
 t1         | 2000005 | txx_xxxx | distributed | localhost |    58639 |       8192
 t1         | 2000006 | txx_xxxx | distributed | localhost |    58639 |      24576
 t1         | 2000007 | txx_xxxx | distributed | localhost |    58639 |      24576
 t1         | 2000008 | txx_xxxx | distributed | localhost |    58639 |      24576
 t1         | 2000009 | txx_xxxx | distributed | localhost |    58639 |      24576
(10 rows)

SELECT spq_add_node('localhost', :worker_2_port);
 spq_add_node
---------------------------------------------------------------------
           10
(1 row)

select spq_rebalance_start();
NOTICE:  Scheduled 5 moves as job xxx
DETAIL:  Rebalance scheduled as background job
CONTEXT:  referenced column: spq_rebalance_start
 spq_rebalance_start
---------------------------------------------------------------------
                   1
(1 row)

--wait till all tasks done
select pg_sleep(120);
 pg_sleep
---------------------------------------------------------------------

(1 row)

select * from spq_shards;
 table_name | shardid | shard_name | table_type  | nodename  | nodeport | shard_size
---------------------------------------------------------------------
 t1         | 2000000 | txx_xxxx | distributed | localhost |    58641 |      24576
 t1         | 2000001 | txx_xxxx | distributed | localhost |    58641 |      24576
 t1         | 2000002 | txx_xxxx | distributed | localhost |    58641 |      24576
 t1         | 2000003 | txx_xxxx | distributed | localhost |    58641 |      24576
 t1         | 2000004 | txx_xxxx | distributed | localhost |    58641 |      24576
 t1         | 2000005 | txx_xxxx | distributed | localhost |    58639 |       8192
 t1         | 2000006 | txx_xxxx | distributed | localhost |    58639 |      24576
 t1         | 2000007 | txx_xxxx | distributed | localhost |    58639 |      24576
 t1         | 2000008 | txx_xxxx | distributed | localhost |    58639 |      24576
 t1         | 2000009 | txx_xxxx | distributed | localhost |    58639 |      24576
(10 rows)

----------------------- test 2: move shard && rebalance -----------------------------
-- move  3 shards from worker1 to worker2
-- expect error shard already on worker 2
select spq_move_shard_placement(2000000, 'localhost', :worker_1_port, 'localhost', :worker_2_port);
WARNING:  shard is already present on node localhost:xxxxx
DETAIL:  Move may have already completed.
CONTEXT:  referenced column: spq_move_shard_placement
 spq_move_shard_placement
---------------------------------------------------------------------

(1 row)

select spq_move_shard_placement(2000005, 'localhost', :worker_1_port, 'localhost', :worker_2_port);
 spq_move_shard_placement
---------------------------------------------------------------------

(1 row)

select spq_move_shard_placement(2000006, 'localhost', :worker_1_port, 'localhost', :worker_2_port);
 spq_move_shard_placement
---------------------------------------------------------------------

(1 row)

select spq_move_shard_placement(2000007, 'localhost', :worker_1_port, 'localhost', :worker_2_port);
 spq_move_shard_placement
---------------------------------------------------------------------

(1 row)

select * from spq_shards;
 table_name | shardid | shard_name | table_type  | nodename  | nodeport | shard_size
---------------------------------------------------------------------
 t1         | 2000000 | txx_xxxx | distributed | localhost |    58641 |      24576
 t1         | 2000001 | txx_xxxx | distributed | localhost |    58641 |      24576
 t1         | 2000002 | txx_xxxx | distributed | localhost |    58641 |      24576
 t1         | 2000003 | txx_xxxx | distributed | localhost |    58641 |      24576
 t1         | 2000004 | txx_xxxx | distributed | localhost |    58641 |      24576
 t1         | 2000005 | txx_xxxx | distributed | localhost |    58641 |       8192
 t1         | 2000006 | txx_xxxx | distributed | localhost |    58641 |      24576
 t1         | 2000007 | txx_xxxx | distributed | localhost |    58641 |      24576
 t1         | 2000008 | txx_xxxx | distributed | localhost |    58639 |      24576
 t1         | 2000009 | txx_xxxx | distributed | localhost |    58639 |      24576
(10 rows)

select spq_rebalance_start();
NOTICE:  Scheduled 3 moves as job xxx
DETAIL:  Rebalance scheduled as background job
CONTEXT:  referenced column: spq_rebalance_start
 spq_rebalance_start
---------------------------------------------------------------------
                   2
(1 row)

--wait till all tasks done
select pg_sleep(120);
 pg_sleep
---------------------------------------------------------------------

(1 row)

select * from spq_shards;
 table_name | shardid | shard_name | table_type  | nodename  | nodeport | shard_size
---------------------------------------------------------------------
 t1         | 2000000 | txx_xxxx | distributed | localhost |    58639 |      24576
 t1         | 2000001 | txx_xxxx | distributed | localhost |    58639 |      24576
 t1         | 2000002 | txx_xxxx | distributed | localhost |    58639 |      24576
 t1         | 2000003 | txx_xxxx | distributed | localhost |    58641 |      24576
 t1         | 2000004 | txx_xxxx | distributed | localhost |    58641 |      24576
 t1         | 2000005 | txx_xxxx | distributed | localhost |    58641 |       8192
 t1         | 2000006 | txx_xxxx | distributed | localhost |    58641 |      24576
 t1         | 2000007 | txx_xxxx | distributed | localhost |    58641 |      24576
 t1         | 2000008 | txx_xxxx | distributed | localhost |    58639 |      24576
 t1         | 2000009 | txx_xxxx | distributed | localhost |    58639 |      24576
(10 rows)

drop table t1;
