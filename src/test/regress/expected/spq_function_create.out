\set VERBOSITY terse
CREATE SCHEMA function_create;
SET search_path TO function_create;
-- helper function to verify the function of a coordinator is the same on all workers
CREATE OR REPLACE FUNCTION verify_function_is_same_on_workers(funcname text)
    RETURNS bool
    LANGUAGE plpgsql
AS $func$
DECLARE
    coordinatorSql text;
    workerSql text;
BEGIN
    SELECT pg_get_functiondef(funcname::regprocedure) INTO coordinatorSql;
    FOR workerSql IN SELECT result FROM run_command_on_workers('SELECT pg_get_functiondef(' || quote_literal(funcname) || '::regprocedure)') LOOP
            IF workerSql != coordinatorSql THEN
                RAISE INFO 'functions are different, coordinator:% worker:%', coordinatorSql, workerSql;
                RETURN false;
            END IF;
        END LOOP;

    RETURN true;
END;
$func$;
-- test delegating function calls
CREATE TABLE warnings (
    id int primary key,
    message text
);
NOTICE:  CREATE TABLE / PRIMARY KEY will create implicit index "warnings_pkey" for table "warnings"
SELECT create_distributed_table('warnings', 'id');
 create_distributed_table
---------------------------------------------------------------------

(1 row)

INSERT INTO warnings VALUES (1, 'hello arbitrary config tests');
CREATE FUNCTION warning(int, text)
RETURNS void
LANGUAGE plpgsql AS $$
BEGIN
    RAISE WARNING '%', $2;
END;
$$;
SELECT create_distributed_function('warning(int,text)','$1');
ERROR:  function create_distributed_function(unknown, unknown) does not exist at character 8
-- verify that the function definition is consistent in the cluster
SELECT verify_function_is_same_on_workers('function_create.warning(int,text)');
INFO:  functions are different, coordinator:(4,"CREATE OR REPLACE FUNCTION function_create.warning(integer, text)
 RETURNS void
 LANGUAGE plpgsql
 NOT FENCED NOT SHIPPABLE
AS $function$
BEGIN
    RAISE WARNING '%', $2;
END;
$function$;
") worker:ERROR:  function "function_create.warning(int,text)" does not exist
 verify_function_is_same_on_workers
---------------------------------------------------------------------
 f
(1 row)

-- test a function that performs operation on the single shard of a reference table
CREATE TABLE monotonic_series(used_values int);
SELECT create_reference_table('monotonic_series');
ERROR:  function create_reference_table(unknown) does not exist at character 8
INSERT INTO monotonic_series VALUES (1), (3), (5);
CREATE FUNCTION add_new_item_to_series()
RETURNS int
LANGUAGE SQL
AS $func$
INSERT INTO monotonic_series SELECT max(used_values)+1 FROM monotonic_series RETURNING used_values;
$func$;
-- Create and distribute a simple function
CREATE FUNCTION eq(macaddr, macaddr) RETURNS bool
    AS 'select $1 = $2;'
    LANGUAGE SQL
    IMMUTABLE
    RETURNS NULL ON NULL INPUT;
-- testing alter statements for a distributed function
-- ROWS 5, untested because;
-- ERROR:  ROWS is not applicable when function does not return a set
SELECT verify_function_is_same_on_workers('function_create.eq(macaddr,macaddr)');
INFO:  functions are different, coordinator:(4,"CREATE OR REPLACE FUNCTION function_create.eq(macaddr, macaddr)
 RETURNS boolean
 LANGUAGE sql
 IMMUTABLE STRICT NOT FENCED NOT SHIPPABLE
AS $function$select $1 = $2;$function$;
") worker:ERROR:  function "function_create.eq(macaddr,macaddr)" does not exist
 verify_function_is_same_on_workers
---------------------------------------------------------------------
 f
(1 row)

ALTER FUNCTION eq(macaddr,macaddr) CALLED ON NULL INPUT IMMUTABLE SECURITY INVOKER PARALLEL UNSAFE COST 5;
ERROR:  syntax error at or near "PARALLEL" at character 84
SELECT verify_function_is_same_on_workers('function_create.eq(macaddr,macaddr)');
INFO:  functions are different, coordinator:(4,"CREATE OR REPLACE FUNCTION function_create.eq(macaddr, macaddr)
 RETURNS boolean
 LANGUAGE sql
 IMMUTABLE STRICT NOT FENCED NOT SHIPPABLE
AS $function$select $1 = $2;$function$;
") worker:ERROR:  function "function_create.eq(macaddr,macaddr)" does not exist
 verify_function_is_same_on_workers
---------------------------------------------------------------------
 f
(1 row)

ALTER FUNCTION eq(macaddr,macaddr) RETURNS NULL ON NULL INPUT STABLE SECURITY DEFINER PARALLEL RESTRICTED;
ERROR:  syntax error at or near "PARALLEL" at character 87
SELECT verify_function_is_same_on_workers('function_create.eq(macaddr,macaddr)');
INFO:  functions are different, coordinator:(4,"CREATE OR REPLACE FUNCTION function_create.eq(macaddr, macaddr)
 RETURNS boolean
 LANGUAGE sql
 IMMUTABLE STRICT NOT FENCED NOT SHIPPABLE
AS $function$select $1 = $2;$function$;
") worker:ERROR:  function "function_create.eq(macaddr,macaddr)" does not exist
 verify_function_is_same_on_workers
---------------------------------------------------------------------
 f
(1 row)

ALTER FUNCTION eq(macaddr,macaddr) STRICT VOLATILE PARALLEL SAFE;
ERROR:  syntax error at or near "PARALLEL" at character 52
SELECT verify_function_is_same_on_workers('function_create.eq(macaddr,macaddr)');
INFO:  functions are different, coordinator:(4,"CREATE OR REPLACE FUNCTION function_create.eq(macaddr, macaddr)
 RETURNS boolean
 LANGUAGE sql
 IMMUTABLE STRICT NOT FENCED NOT SHIPPABLE
AS $function$select $1 = $2;$function$;
") worker:ERROR:  function "function_create.eq(macaddr,macaddr)" does not exist
 verify_function_is_same_on_workers
---------------------------------------------------------------------
 f
(1 row)

-- Test SET/RESET for alter function
ALTER ROUTINE eq(macaddr,macaddr) SET client_min_messages TO debug;
ERROR:  syntax error at or near "ROUTINE" at character 7
SELECT verify_function_is_same_on_workers('function_create.eq(macaddr,macaddr)');
INFO:  functions are different, coordinator:(4,"CREATE OR REPLACE FUNCTION function_create.eq(macaddr, macaddr)
 RETURNS boolean
 LANGUAGE sql
 IMMUTABLE STRICT NOT FENCED NOT SHIPPABLE
AS $function$select $1 = $2;$function$;
") worker:ERROR:  function "function_create.eq(macaddr,macaddr)" does not exist
 verify_function_is_same_on_workers
---------------------------------------------------------------------
 f
(1 row)

ALTER FUNCTION eq(macaddr,macaddr) RESET client_min_messages;
SELECT verify_function_is_same_on_workers('function_create.eq(macaddr,macaddr)');
INFO:  functions are different, coordinator:(4,"CREATE OR REPLACE FUNCTION function_create.eq(macaddr, macaddr)
 RETURNS boolean
 LANGUAGE sql
 IMMUTABLE STRICT NOT FENCED NOT SHIPPABLE
AS $function$select $1 = $2;$function$;
") worker:ERROR:  function "function_create.eq(macaddr,macaddr)" does not exist
 verify_function_is_same_on_workers
---------------------------------------------------------------------
 f
(1 row)

ALTER FUNCTION eq(macaddr,macaddr) SET search_path TO 'sch'';ma', public;
SELECT verify_function_is_same_on_workers('function_create.eq(macaddr,macaddr)');
INFO:  functions are different, coordinator:(5,"CREATE OR REPLACE FUNCTION function_create.eq(macaddr, macaddr)
 RETURNS boolean
 LANGUAGE sql
 IMMUTABLE STRICT NOT FENCED NOT SHIPPABLE
 SET search_path TO ""sch';ma"", public
AS $function$select $1 = $2;$function$;
") worker:ERROR:  function "function_create.eq(macaddr,macaddr)" does not exist
 verify_function_is_same_on_workers
---------------------------------------------------------------------
 f
(1 row)

ALTER FUNCTION eq(macaddr,macaddr) RESET search_path;
-- rename function and make sure the new name can be used on the workers
ALTER FUNCTION eq(macaddr,macaddr) RENAME TO eq2;
SELECT verify_function_is_same_on_workers('function_create.eq2(macaddr,macaddr)');
INFO:  functions are different, coordinator:(4,"CREATE OR REPLACE FUNCTION function_create.eq2(macaddr, macaddr)
 RETURNS boolean
 LANGUAGE sql
 IMMUTABLE STRICT NOT FENCED NOT SHIPPABLE
AS $function$select $1 = $2;$function$;
") worker:ERROR:  function "function_create.eq2(macaddr,macaddr)" does not exist
 verify_function_is_same_on_workers
---------------------------------------------------------------------
 f
(1 row)

-- user-defined aggregates with & without strict
create function sum2_sfunc_strict(state int, x int)
returns int immutable strict language plpgsql as $$
begin return state + x;
end;
$$;
create function sum2_finalfunc_strict(state int)
returns int immutable strict language plpgsql as $$
begin return state * 2;
end;
$$;
create function sum2_sfunc(state int, x int)
returns int immutable language plpgsql as $$
begin return state + x;
end;
$$;
create function sum2_finalfunc(state int)
returns int immutable language plpgsql as $$
begin return state * 2;
end;
$$;
create aggregate sum2 (int) (
    sfunc = sum2_sfunc,
    stype = int,
    finalfunc = sum2_finalfunc,
    combinefunc = sum2_sfunc,
    initcond = '0'
);
WARNING:  aggregate attribute "combinefunc" not recognized
create aggregate sum2_strict (int) (
    sfunc = sum2_sfunc_strict,
    stype = int,
    finalfunc = sum2_finalfunc_strict,
    combinefunc = sum2_sfunc_strict
);
WARNING:  aggregate attribute "combinefunc" not recognized
-- user-defined aggregates with multiple-parameters
create function psum_sfunc(s int, x int, y int)
returns int immutable language plpgsql as $$
begin return coalesce(s,0) + coalesce(x*y+3,1);
end;
$$;
create  function psum_sfunc_strict(s int, x int, y int)
returns int immutable strict language plpgsql as $$
begin return coalesce(s,0) + coalesce(x*y+3,1);
end;
$$;
create function psum_combinefunc(s1 int, s2 int)
returns int immutable language plpgsql as $$
begin return coalesce(s1,0) + coalesce(s2,0);
end;
$$;
create function psum_combinefunc_strict(s1 int, s2 int)
returns int immutable strict language plpgsql as $$
begin return coalesce(s1,0) + coalesce(s2,0);
end;
$$;
create function psum_finalfunc(x int)
returns int immutable language plpgsql as $$
begin return x * 2;
end;
$$;
create function psum_finalfunc_strict(x int)
returns int immutable strict language plpgsql as $$
begin return x * 2;
end;
$$;
create aggregate psum(int, int)(
    sfunc=psum_sfunc,
    combinefunc=psum_combinefunc,
    finalfunc=psum_finalfunc,
    stype=int
);
WARNING:  aggregate attribute "combinefunc" not recognized
create aggregate psum_strict(int, int)(
    sfunc=psum_sfunc_strict,
    combinefunc=psum_combinefunc_strict,
    finalfunc=psum_finalfunc_strict,
    stype=int,
    initcond=0
);
WARNING:  aggregate attribute "combinefunc" not recognized
-- generate test data
create table aggdata (id int, key int, val int, valf float8);
select create_distributed_table('aggdata', 'id');
 create_distributed_table
---------------------------------------------------------------------

(1 row)

