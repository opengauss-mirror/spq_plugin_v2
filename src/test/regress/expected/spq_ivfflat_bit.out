SET spq.propagate_set_commands = 'local';
-- hamming
CREATE TABLE t4 (val bit(3));
SELECT create_distributed_table('t4', 'val');
ERROR:  data type bit has no default operator class for specified partition method
DETAIL:  Partition column types must have a default operator class defined.
CONTEXT:  referenced column: create_distributed_table
DROP TABLE t4;
CREATE TABLE t4 (id int, val bit(3));
SELECT create_distributed_table('t4', 'id');
 create_distributed_table
---------------------------------------------------------------------

(1 row)

INSERT INTO t4 (id, val) VALUES (1, B'000'), (2, B'100'), (3, B'111'), (4, NULL);
CREATE INDEX ON t4 USING ivfflat (val bit_hamming_ops) WITH (lists = 1);
NOTICE:  ivfflat index created with little data
DETAIL:  This will cause low recall.
HINT:  Drop the index until the table has more data.
INSERT INTO t4 (id, val) VALUES (5, B'110');
BEGIN;
SET local enable_seqscan = off;
EXPLAIN SELECT * FROM t4 ORDER BY val <~> B'111';
                                             QUERY PLAN
---------------------------------------------------------------------
 Sort  (cost=8304.82..8554.82 rows=100000 width=21)
   Sort Key: remote_scan.worker_column_3
   ->  Spq extensible Adaptive  (cost=0.00..0.00 rows=100000 width=21)
         Task Count: 4
         Tasks Shown: One of 4
         ->  Task
               Node: host=localhost port=xxxxx dbname=regression
               ->  Seq Scan on t_xxxx t4  (cost=10000000000.00..1000000000101.00 rows=1 width=13)
(8 rows)

SELECT * FROM t4 ORDER BY val <~> B'111';
 id | val
---------------------------------------------------------------------
  3 | 111
  5 | 110
  2 | 100
  1 | 000
  4 |
(5 rows)

EXPLAIN SELECT COUNT(*) FROM (SELECT * FROM t4 ORDER BY val <~> (SELECT NULL::bit)) tt;
                                                    QUERY PLAN
---------------------------------------------------------------------
 Aggregate  (cost=250.00..250.01 rows=1 width=40)
   ->  Spq extensible Adaptive  (cost=0.00..0.00 rows=100000 width=8)
         Task Count: 4
         Tasks Shown: One of 4
         ->  Task
               Node: host=localhost port=xxxxx dbname=regression
               ->  Aggregate  (cost=8.29..8.30 rows=1 width=8)
                     ->  Ann Index Scan using t_val_idx_xxxx on t_xxxx t4  (cost=4.27..8.28 rows=1 width=13)
                           Order By: (val <~> $0)
                           InitPlan 1 (returns $0)
                             ->  Result  (cost=0.00..0.01 rows=1 width=0)
(11 rows)

SELECT COUNT(*) FROM (SELECT * FROM t4 ORDER BY val <~> (SELECT NULL::bit)) tt;
 count
---------------------------------------------------------------------
     4
(1 row)

COMMIT;
DROP TABLE t4;
-- varbit
CREATE TABLE t4 (val varbit(3));
SELECT create_distributed_table('t4', 'val');
ERROR:  data type bit varying has no default operator class for specified partition method
DETAIL:  Partition column types must have a default operator class defined.
CONTEXT:  referenced column: create_distributed_table
DROP TABLE t4;
CREATE TABLE t4 (id int, val varbit(3));
SELECT create_distributed_table('t4', 'id');
 create_distributed_table
---------------------------------------------------------------------

(1 row)

CREATE INDEX ON t4 USING ivfflat (val bit_hamming_ops) WITH (lists = 1);
ERROR:  type not supported for ivfflat index
CREATE INDEX ON t4 USING ivfflat ((val::bit(3)) bit_hamming_ops) WITH (lists = 1);
NOTICE:  ivfflat index created with little data
DETAIL:  This will cause low recall.
HINT:  Drop the index until the table has more data.
CREATE INDEX ON t4 USING ivfflat ((val::bit(64001)) bit_hamming_ops) WITH (lists = 1);
ERROR:  column cannot have more than 64000 dimensions for ivfflat index
CREATE INDEX ON t4 USING ivfflat ((val::bit(2)) bit_hamming_ops) WITH (lists = 5);
NOTICE:  ivfflat index created with little data
DETAIL:  This will cause low recall.
HINT:  Drop the index until the table has more data.
DROP TABLE t4;
SET spq.propagate_set_commands = DEFAULT;
