-- ===================================================================
-- test recursive planning functionality
-- ===================================================================
-- the subquery is safe to pushdown, should not
-- recursively plan
SET spq.enable_repartition_joins = ON;
SELECT
	user_id, value_1
FROM
	(SELECT user_id, value_1 FROM users_table) as foo
ORDER BY 1 DESC, 2 DESC LIMIT 3;
 user_id | value_1
---------------------------------------------------------------------
       6 |       5
       6 |       5
       6 |       3
(3 rows)

-- the subquery is safe to pushdown, should not
-- recursively plan
SELECT
	sum(sel_val_1), sum(sel_val_2)
FROM
	(SELECT max(value_1) as  sel_val_1, min(value_2) as sel_val_2 FROM users_table GROUP BY user_id) as foo;
 sum | sum
---------------------------------------------------------------------
  29 |   1
(1 row)

-- the subquery is safe to pushdown, should not
-- recursively plan
SELECT
	min(user_id), max(value_1)
FROM
	(SELECT user_id, value_1 FROM users_table) as foo;
 min | max
---------------------------------------------------------------------
   1 |   5
(1 row)

-- the subquery is safe to pushdown, should not
-- recursively plan
SELECT
	min(user_id)
FROM
	(SELECT user_id, value_1 FROM users_table GROUP BY user_id, value_1) as bar;
 min
---------------------------------------------------------------------
   1
(1 row)

-- the subquery is safe to pushdown, should not
-- recursively plan
SELECT
	min(user_id), sum(max_value_1)
FROM
	(SELECT user_id, max(value_1) as max_value_1 FROM users_table GROUP BY user_id) as bar;
 min | sum
---------------------------------------------------------------------
   1 |  29
(1 row)

-- subqueries in FROM clause with LIMIT should be recursively planned
SELECT
   user_id
FROM
    (SELECT
    	DISTINCT users_table.user_id
     FROM
     	users_table, events_table
     WHERE
     	users_table.user_id = events_table.user_id AND
     event_type IN (1,2,3,4)
     ORDER BY 1 DESC LIMIT 5
     ) as foo
    ORDER BY 1 DESC;
 user_id
---------------------------------------------------------------------
       6
       5
       4
       3
       2
(5 rows)

SET spq.enable_repartition_joins = default;
